<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ReportsApiController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">interop-transaction-engine</a> &gt; <a href="index.source.html" class="el_package">com.comviva.interop.txnengine.controllers</a> &gt; <span class="el_source">ReportsApiController.java</span></div><h1>ReportsApiController.java</h1><pre class="source lang-java linenums">package com.comviva.interop.txnengine.controllers;

import java.util.ArrayList;
import java.util.Iterator;
import java.util.List;

import javax.persistence.EntityManager;
import javax.persistence.PersistenceContext;
import javax.persistence.TypedQuery;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Controller;

import com.comviva.interop.txnengine.api.ReportsApi;
import com.comviva.interop.txnengine.configuration.BrokerServiceURLProperties;
import com.comviva.interop.txnengine.configuration.Resource;

import com.comviva.interop.txnengine.entities.ChannelUserDetails;
import com.comviva.interop.txnengine.entities.InteropTransactionDetails;
import com.comviva.interop.txnengine.enums.LogConstants;
import com.comviva.interop.txnengine.exception.InteropException;
import com.comviva.interop.txnengine.enums.Constants;
import com.comviva.interop.txnengine.model.OrangeMoneyOperationDetail;
import com.comviva.interop.txnengine.model.OrangeMoneyOperations;
import com.comviva.interop.txnengine.model.OrangeMoneyTechnicalAccountDetail;
import com.comviva.interop.txnengine.model.OrangeMoneyTechnicalAccounts;
import com.comviva.interop.txnengine.repositories.ChannelUserDetailsRepository;
import com.comviva.interop.txnengine.util.LoggerUtil;
import com.comviva.interop.txnengine.util.StringUtils;

@Controller
<span class="fc" id="L36">public class ReportsApiController implements ReportsApi {</span>

<span class="fc" id="L38">    private static final Logger LOGGER = LoggerFactory.getLogger(ReportsApiController.class);</span>
    
    @Autowired
    private ChannelUserDetailsRepository channelUserDetailsRepository;
    
    @Autowired
    private Resource resource;
    
    @PersistenceContext
    @Autowired
    private EntityManager entityManager;
    
    @Autowired
    private BrokerServiceURLProperties brokerServiceURLProperties;
    
    
    @Override
    public ResponseEntity&lt;OrangeMoneyOperations&gt; getOrangeMoneyOperations(String countryId, String from, int limit) {
        
<span class="fc" id="L57">        String message = LoggerUtil.prepareLogDetailForOMOperationsRequest(LogConstants.INCOMING_REQUEST_EVENT_TYPE.getValue(), countryId, from, limit);</span>
<span class="fc" id="L58">        LOGGER.info(&quot;OM operations request: {}&quot;, message);</span>
<span class="fc" id="L59">        OrangeMoneyOperations orangeMoneyOperations = new OrangeMoneyOperations();</span>
<span class="fc" id="L60">        List&lt;OrangeMoneyOperationDetail&gt; orangeMoneyOperationDetailsList = new ArrayList&lt;&gt;();</span>
        try {
<span class="pc bpc" id="L62" title="1 of 2 branches missed.">            if(brokerServiceURLProperties.getUrlCountryIdValue().equals(countryId)) {</span>
<span class="fc" id="L63">                TypedQuery&lt;InteropTransactionDetails&gt; typedQuery = entityManager.createQuery(getDynamicQuery(), InteropTransactionDetails.class);</span>
<span class="fc" id="L64">                typedQuery.setParameter(&quot;from&quot;, StringUtils.stringToDateFormat(from, resource.getInputDateFormat()));</span>
<span class="fc" id="L65">                typedQuery.setMaxResults(limit);</span>
<span class="fc" id="L66">                prepareTxnDetails(orangeMoneyOperationDetailsList, typedQuery.getResultList());</span>
        }
<span class="fc" id="L68">        orangeMoneyOperations.setData(orangeMoneyOperationDetailsList);    </span>
<span class="fc" id="L69">        String responseMessage = LoggerUtil.prepareLogDetailForOMOperationResponse(LogConstants.OUTGOING_RESPONSE_EVENT_TYPE.getValue(), orangeMoneyOperations,countryId, null);</span>
<span class="fc" id="L70">        LOGGER.info(&quot;OM operations response: {}&quot;, responseMessage);</span>
<span class="fc" id="L71">        return new ResponseEntity&lt;&gt;(orangeMoneyOperations, HttpStatus.OK);</span>
<span class="nc" id="L72">        }catch(InteropException ex) {</span>
<span class="nc" id="L73">            String exceptionMessage = LoggerUtil.prepareLogDetailForOMOperationResponse(LogConstants.OUTGOING_RESPONSE_EVENT_TYPE.getValue(), orangeMoneyOperations, countryId, ex);</span>
<span class="nc" id="L74">            LOGGER.info(&quot;OM OPERATIONS response: {}&quot;, exceptionMessage);</span>
<span class="nc" id="L75">            return new ResponseEntity&lt;&gt;(orangeMoneyOperations, HttpStatus.OK);</span>
        }
<span class="nc" id="L77">        catch(Exception e) {</span>
<span class="nc" id="L78">            String exceptionMessage = LoggerUtil.prepareLogDetailForOMOperationResponse(LogConstants.OUTGOING_RESPONSE_EVENT_TYPE.getValue(), orangeMoneyOperations, countryId, e);</span>
<span class="nc" id="L79">            LOGGER.info(&quot;OM OPERATIONS response: {}&quot;, exceptionMessage);</span>
<span class="nc" id="L80">            return new ResponseEntity&lt;&gt;(orangeMoneyOperations, HttpStatus.OK);</span>
        }


    }

    private  List&lt;OrangeMoneyOperationDetail&gt; prepareTxnDetails(List&lt;OrangeMoneyOperationDetail&gt; orangeMoneyOperationDetailsList, List&lt;InteropTransactionDetails&gt; interopTransactions) {
<span class="pc bpc" id="L87" title="2 of 4 branches missed.">    	 if(null != interopTransactions &amp;&amp; !interopTransactions.isEmpty()) {</span>
<span class="fc bfc" id="L88" title="All 2 branches covered.">             for(InteropTransactionDetails interopTransactionDetails: interopTransactions) {</span>
<span class="fc" id="L89">                 OrangeMoneyOperationDetail orangeMoneyOperationDetail = new OrangeMoneyOperationDetail();</span>
<span class="fc" id="L90">                 orangeMoneyOperationDetail.setAddonStatus(interopTransactionDetails.getTxnStatus());</span>
<span class="fc" id="L91">                 orangeMoneyOperationDetail.setAmount(interopTransactionDetails.getAmount().doubleValue());</span>
<span class="fc" id="L92">                 orangeMoneyOperationDetail.setCreationDate(interopTransactionDetails.getCreatedDate().toString());</span>
<span class="fc" id="L93">                 orangeMoneyOperationDetail.setCurrency(interopTransactionDetails.getCurrency());</span>
<span class="fc" id="L94">                 orangeMoneyOperationDetail.setPayeeMsisdn(interopTransactionDetails.getThirdPartyPayee());</span>
<span class="fc" id="L95">                 orangeMoneyOperationDetail.setPayeePayId(interopTransactionDetails.getPayeePayId());</span>
<span class="fc" id="L96">                 orangeMoneyOperationDetail.setPayeeProvider(interopTransactionDetails.getPayeeProvider());</span>
<span class="pc bpc" id="L97" title="1 of 2 branches missed.">                 orangeMoneyOperationDetail.setPayeeTechnical(interopTransactionDetails.getIsPayeeTechnical().equals(Constants.ZERO.getValue()) ? Boolean.FALSE : Boolean.TRUE);</span>
<span class="fc" id="L98">                 orangeMoneyOperationDetail.setPayerChannelUserCode(interopTransactionDetails.getPayerChannelUserCode());</span>
<span class="fc" id="L99">                 orangeMoneyOperationDetail.setPayerMsisdn(interopTransactionDetails.getThirdPartyPayer());</span>
<span class="fc" id="L100">                 orangeMoneyOperationDetail.setPayerPayId(interopTransactionDetails.getPayerPayId());</span>
<span class="fc" id="L101">                 orangeMoneyOperationDetail.setPayerProvider(interopTransactionDetails.getPayerProvider());</span>
<span class="pc bpc" id="L102" title="1 of 2 branches missed.">                 orangeMoneyOperationDetail.setPayerTechnical(interopTransactionDetails.getIsPayerTechnical().equals(Constants.ZERO.getValue() ) ? Boolean.FALSE: Boolean.TRUE);</span>
<span class="fc" id="L103">                 orangeMoneyOperationDetail.setServiceType(interopTransactionDetails.getThirdPartyTxnType());</span>
<span class="fc" id="L104">                 orangeMoneyOperationDetail.setTxnDate(interopTransactionDetails.getCreatedDate().toString());</span>
<span class="fc" id="L105">                 orangeMoneyOperationDetail.setTxnId(interopTransactionDetails.getThirdPartyRefId());</span>
<span class="fc" id="L106">                 orangeMoneyOperationDetail.setTxnMode(interopTransactionDetails.getTxnMode());</span>
<span class="fc" id="L107">                 orangeMoneyOperationDetail.setTxnStatus(interopTransactionDetails.getTxnStatus());</span>
<span class="fc" id="L108">                 orangeMoneyOperationDetailsList.add(orangeMoneyOperationDetail);    </span>
<span class="fc" id="L109">             }</span>
         }
<span class="fc" id="L111">    	 return orangeMoneyOperationDetailsList;</span>
    }
    @Override
    public ResponseEntity&lt;OrangeMoneyTechnicalAccounts&gt; getTechnicalWallets(String countryId) {
<span class="fc" id="L115">        String message = LoggerUtil.prepareLogDetailForTechnicalWalletsRequest(LogConstants.INCOMING_REQUEST_EVENT_TYPE.getValue(), countryId);</span>
<span class="fc" id="L116">        LOGGER.info(&quot;Technical wallet request: {}&quot;, message);</span>
<span class="fc" id="L117">        OrangeMoneyTechnicalAccounts orangeMoneyTechnicalAccounts = new OrangeMoneyTechnicalAccounts();</span>
<span class="fc" id="L118">        List&lt;OrangeMoneyTechnicalAccountDetail&gt; orangeMoneyTechnicalAccountDetailsList = new ArrayList&lt;&gt;();</span>
        try {
<span class="pc bpc" id="L120" title="1 of 2 branches missed.">            if(brokerServiceURLProperties.getUrlCountryIdValue().equals(countryId)) {</span>
<span class="fc" id="L121">                Iterator&lt;ChannelUserDetails&gt; channelUserDetailsIterable = channelUserDetailsRepository.findAll().iterator();</span>
<span class="fc bfc" id="L122" title="All 2 branches covered.">                while (channelUserDetailsIterable.hasNext()) {</span>
<span class="fc" id="L123">                    ChannelUserDetails chUserDetails = channelUserDetailsIterable.next();</span>
<span class="fc" id="L124">                    OrangeMoneyTechnicalAccountDetail orangeMoneyTechnicalAccountDetail = new OrangeMoneyTechnicalAccountDetail();</span>
<span class="fc" id="L125">                    orangeMoneyTechnicalAccountDetail.setChannelUserCode(chUserDetails.getChannelUserCode());</span>
<span class="fc" id="L126">                    orangeMoneyTechnicalAccountDetail.setCreationDate(chUserDetails.getCreatedDate().toString());</span>
<span class="fc" id="L127">                    orangeMoneyTechnicalAccountDetail.setMsisdn(chUserDetails.getMsisdn());</span>
<span class="fc" id="L128">                    orangeMoneyTechnicalAccountDetail.setDescription(chUserDetails.getDescription());</span>
<span class="fc" id="L129">                    orangeMoneyTechnicalAccountDetail.setOptional(chUserDetails.getOptional());</span>
<span class="fc" id="L130">                    orangeMoneyTechnicalAccountDetail.setType(chUserDetails.getType());</span>
<span class="fc" id="L131">                    orangeMoneyTechnicalAccountDetailsList.add(orangeMoneyTechnicalAccountDetail);</span>
<span class="fc" id="L132">                }   </span>
            }
<span class="fc" id="L134">            orangeMoneyTechnicalAccounts.setData(orangeMoneyTechnicalAccountDetailsList);</span>
<span class="fc" id="L135">            String responseMessage = LoggerUtil.prepareLogDetailForTechnicalWalletsResponse(LogConstants.OUTGOING_RESPONSE_EVENT_TYPE.getValue(), orangeMoneyTechnicalAccounts, countryId, null);</span>
<span class="fc" id="L136">            LOGGER.info(&quot;Technical wallets response: {}&quot;, responseMessage);</span>
<span class="fc" id="L137">            return new ResponseEntity&lt;&gt;(orangeMoneyTechnicalAccounts, HttpStatus.OK);</span>
        }
<span class="nc" id="L139">        catch(Exception e) {</span>
<span class="nc" id="L140">            String responseMessage = LoggerUtil.prepareLogDetailForTechnicalWalletsResponse(LogConstants.OUTGOING_RESPONSE_EVENT_TYPE.getValue(), orangeMoneyTechnicalAccounts, countryId, e);</span>
<span class="nc" id="L141">            LOGGER.info(&quot;Technical wallets response: {}&quot;, responseMessage);</span>
<span class="nc" id="L142">            return new ResponseEntity&lt;&gt;(orangeMoneyTechnicalAccounts, HttpStatus.OK);</span>
        }
    }
    
    private String getDynamicQuery() {
<span class="fc" id="L147">        StringBuilder dynamicQuery = new StringBuilder();</span>
<span class="fc" id="L148">        dynamicQuery.append(&quot;SELECT t FROM InteropTransactionDetails t where t.createdDate &gt;= :from order by createdDate&quot;);       </span>
<span class="fc" id="L149">        return dynamicQuery.toString();</span>
    }
    

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>