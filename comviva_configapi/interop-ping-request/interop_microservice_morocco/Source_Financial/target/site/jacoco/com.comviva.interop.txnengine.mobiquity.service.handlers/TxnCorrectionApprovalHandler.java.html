<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TxnCorrectionApprovalHandler.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">interop-transaction-engine</a> &gt; <a href="index.source.html" class="el_package">com.comviva.interop.txnengine.mobiquity.service.handlers</a> &gt; <span class="el_source">TxnCorrectionApprovalHandler.java</span></div><h1>TxnCorrectionApprovalHandler.java</h1><pre class="source lang-java linenums">package com.comviva.interop.txnengine.mobiquity.service.handlers;

import java.util.HashMap;
import java.util.Map;
import java.util.Optional;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.web.client.RestClientException;

import com.comviva.interop.txnengine.configuration.BrokerServiceProperties;
import com.comviva.interop.txnengine.configuration.BrokerServiceURLProperties;
import com.comviva.interop.txnengine.configuration.Resource;
import com.comviva.interop.txnengine.configuration.ServiceTemplateNames;
import com.comviva.interop.txnengine.entities.ChannelUserDetails;
import com.comviva.interop.txnengine.entities.InteropTransactions;
import com.comviva.interop.txnengine.enums.Constants;
import com.comviva.interop.txnengine.enums.LogConstants;
import com.comviva.interop.txnengine.enums.RequestType;
import com.comviva.interop.txnengine.enums.SMSNotificationCodes;
import com.comviva.interop.txnengine.enums.ThirdPartyResponseCodes;
import com.comviva.interop.txnengine.enums.TransactionStatus;
import com.comviva.interop.txnengine.model.Response;
import com.comviva.interop.txnengine.model.TxnCorrection;
import com.comviva.interop.txnengine.repositories.InteropTransactionDetailsRepository;
import com.comviva.interop.txnengine.repositories.InteropTransactionsRepository;
import com.comviva.interop.txnengine.util.LoggerUtil;
import com.comviva.interop.txnengine.util.MobiquityConst;
import com.comviva.interop.txnengine.util.StringUtils;
import com.comviva.interop.txnengine.util.ThirdPartyCaller;
import com.comviva.interop.txnengine.util.TransactionDataPreparationUtil;

@Service
<span class="fc" id="L36">public class TxnCorrectionApprovalHandler {</span>
    
<span class="fc" id="L38">	 private static final Logger LOGGER = LoggerFactory.getLogger(TxnCorrectionApprovalHandler.class);</span>
    
    @Autowired
    private BrokerServiceProperties thirdPartyProperties;
    
    @Autowired
    private ThirdPartyCaller thirdPartyCaller;

    @Autowired
    private InteropTransactionDetailsRepository interopTransactionDetailsRepository;

    @Autowired
    private InteropTransactionsRepository interOpTransactionRepository;

    @Autowired
    private UserEnquiryHandler userEnquiryHandler;
    
    @Autowired
    private ServiceTemplateNames serviceTemplateNames;
    
    @Autowired
    private BrokerServiceURLProperties brokerServiceURLProperties;
    
    @Autowired
    private Resource resource;
    
    public void doTxnCorrectionApprove(InteropTransactions interopTransaction, String pin, String lang,
            String interOpRefId, String txnId, ChannelUserDetails channelUserDetails,String txnMode, String em) {
    	try {
<span class="fc" id="L67">    		interopTransactionDetailsRepository.save(TransactionDataPreparationUtil</span>
<span class="fc" id="L68">                    .prepareRequestTransactionDetails(interopTransaction, RequestType.REQTRCORCF.toString(),thirdPartyProperties,Constants.ZERO.getValue(), Constants.ONE.getValue()));</span>
<span class="fc" id="L69">            Response txnCorrectionApproveResponse = execute(prepareTxnCorrection(interopTransaction, txnId,</span>
<span class="fc" id="L70">                    channelUserDetails, thirdPartyProperties.getTxnCorrectionApproveActionType()), interOpRefId,txnMode);</span>
<span class="fc bfc" id="L71" title="All 2 branches covered.">            if (!Optional.ofNullable(txnCorrectionApproveResponse.getMappingResponse()).isPresent()) {</span>
<span class="fc" id="L72">                interOpTransactionRepository.save(TransactionDataPreparationUtil.updateTransactionStatus(interopTransaction,</span>
<span class="fc" id="L73">                        TransactionStatus.TRANSACTION_CORRECTION_AMBIGUOUS.getStatus()));</span>
<span class="fc" id="L74">                interopTransactionDetailsRepository.save(TransactionDataPreparationUtil.prepareResponseTransactionDetails(</span>
<span class="fc" id="L75">                        interopTransaction, RequestType.TRCORCFRESP.toString(), txnCorrectionApproveResponse,thirdPartyProperties,Constants.ZERO.getValue(), Constants.ONE.getValue()));</span>
<span class="fc" id="L76">            } else if (ThirdPartyResponseCodes.SUCCESS.getMappedCode()</span>
<span class="fc bfc" id="L77" title="All 2 branches covered.">                    .equals(txnCorrectionApproveResponse.getMappingResponse().getMappingCode())) {</span>
<span class="fc" id="L78">            	interopTransaction.setTxnCorrectionId(txnCorrectionApproveResponse.getWalletResponse().getTxnid());</span>
<span class="fc" id="L79">            	 interOpTransactionRepository.save(TransactionDataPreparationUtil.updateTransactionStatus(interopTransaction,</span>
<span class="fc" id="L80">                         TransactionStatus.TRANSACTION_FAIL.getStatus()));</span>
<span class="fc" id="L81">                interopTransactionDetailsRepository.save(TransactionDataPreparationUtil.prepareResponseTransactionDetails(</span>
<span class="fc" id="L82">                        interopTransaction, RequestType.TRCORCFRESP.toString(), txnCorrectionApproveResponse,thirdPartyProperties,Constants.ZERO.getValue(), Constants.ONE.getValue()));</span>
<span class="fc" id="L83">                userEnquiryHandler.doUserEnquiry(interopTransaction, pin, lang, interOpRefId,</span>
<span class="fc" id="L84">                        SMSNotificationCodes.OFF_US_TXN_CORRECTION_SUCCESS.toString(),txnMode,em);</span>
            } else {
<span class="fc" id="L86">            	 interOpTransactionRepository.save(TransactionDataPreparationUtil.updateTransactionStatus(interopTransaction,</span>
<span class="fc" id="L87">                         TransactionStatus.TRANSACTION_CORRECTION_INITIATED.getStatus()));</span>
<span class="fc" id="L88">                interopTransactionDetailsRepository.save(TransactionDataPreparationUtil.prepareResponseTransactionDetails(</span>
<span class="fc" id="L89">                        interopTransaction, RequestType.TRCORCFRESP.toString(), txnCorrectionApproveResponse,thirdPartyProperties,Constants.ZERO.getValue(), Constants.ONE.getValue()));</span>
            }
    	}
<span class="nc" id="L92">    	catch(RestClientException restException) {</span>
<span class="nc" id="L93">    		 interOpTransactionRepository.save(TransactionDataPreparationUtil.updateTransactionStatus(interopTransaction,</span>
<span class="nc" id="L94">                     TransactionStatus.TRANSACTION_CORRECTION_INITIATED.getStatus()));</span>
<span class="nc" id="L95">    		 String message = LoggerUtil.printLog(LogConstants.TXN_CORRECTION_APPORVE.getValue(), restException);</span>
<span class="nc" id="L96">    		 LOGGER.info(&quot;txn correction approve timed out : {}&quot;, message);</span>
<span class="fc" id="L97">    	}</span>
<span class="fc" id="L98">    }</span>

    public Response execute(TxnCorrection txnCorrection, String interopReferenceId,String txnMode) {
<span class="fc" id="L101">        Map&lt;String, String&gt; txnCorrectionApproval = new HashMap&lt;&gt;();</span>
<span class="fc" id="L102">        txnCorrectionApproval.put(MobiquityConst.SESSION_ID.getValue(), interopReferenceId);</span>
<span class="fc" id="L103">        txnCorrectionApproval.put(MobiquityConst.TXNMODE.getValue(), txnMode);</span>
<span class="fc" id="L104">        txnCorrectionApproval.put(MobiquityConst.MSISDN.getValue(), txnCorrection.getMsisdn());</span>
<span class="fc" id="L105">        txnCorrectionApproval.put(MobiquityConst.MSISDN2.getValue(), txnCorrection.getMsisdn2());</span>
<span class="fc" id="L106">        txnCorrectionApproval.put(MobiquityConst.PROVIDER.getValue(), txnCorrection.getProvider());</span>
<span class="fc" id="L107">        txnCorrectionApproval.put(MobiquityConst.PAYID.getValue(), txnCorrection.getPayId());</span>
<span class="fc" id="L108">        txnCorrectionApproval.put(MobiquityConst.AMOUNT.getValue(), txnCorrection.getAmount());</span>
<span class="fc" id="L109">        txnCorrectionApproval.put(MobiquityConst.TXNID.getValue(), txnCorrection.getTxnId());</span>
<span class="fc" id="L110">        txnCorrectionApproval.put(MobiquityConst.USER_TYPE.getValue(), txnCorrection.getUserType());</span>
<span class="fc" id="L111">        txnCorrectionApproval.put(MobiquityConst.USER_TYPE2.getValue(), txnCorrection.getUserType2());</span>
<span class="fc" id="L112">        txnCorrectionApproval.put(MobiquityConst.ACTION.getValue(), txnCorrection.getAction());</span>
<span class="fc" id="L113">        txnCorrectionApproval.put(MobiquityConst.USER_ID.getValue(), txnCorrection.getUserId());</span>
<span class="fc" id="L114">        return thirdPartyCaller.postMobiquityServiceRequest(txnCorrectionApproval,</span>
<span class="fc" id="L115">                serviceTemplateNames.getTxnCorrectionApproveRequestTemplate(), getWalletTxnCorrectionApproveUrl(), interopReferenceId, LogConstants.TXN_CORRECTION_APPORVE.getValue());</span>
    }

    private String getWalletTxnCorrectionApproveUrl() {
<span class="fc" id="L119">        Object[] urlArgs = { resource.getWalletBaseUrl(), brokerServiceURLProperties.getUrlAddonIdValue(),</span>
<span class="fc" id="L120">                brokerServiceURLProperties.getUrlCountryIdValue(), brokerServiceURLProperties.getUrlCurrencyValue() };</span>
<span class="fc" id="L121">        return StringUtils.msgFormat(brokerServiceURLProperties.getTxnCorrectionApproveUrl(), urlArgs);</span>
    }

    public TxnCorrection prepareTxnCorrection(InteropTransactions interopTransaction, String txnId,
            ChannelUserDetails channelUserDetails, String action) {
<span class="fc" id="L126">        TxnCorrection txnCorrection = new TxnCorrection();</span>
<span class="fc" id="L127">        txnCorrection.setMsisdn(interopTransaction.getPayeeMsisdn());</span>
<span class="fc" id="L128">        txnCorrection.setMsisdn2(channelUserDetails.getMsisdn());</span>
<span class="fc" id="L129">        txnCorrection.setAmount(interopTransaction.getAmount().toString());</span>
<span class="fc" id="L130">        txnCorrection.setTxnId(txnId);</span>
<span class="fc" id="L131">        txnCorrection.setUserType(thirdPartyProperties.getSubscriberUserType());</span>
<span class="fc" id="L132">        txnCorrection.setUserType2(thirdPartyProperties.getPayeeUserType());</span>
<span class="fc" id="L133">        txnCorrection.setAction(action);</span>
<span class="fc" id="L134">        txnCorrection.setUserId(channelUserDetails.getUserId());</span>
<span class="fc" id="L135">        return txnCorrection;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>