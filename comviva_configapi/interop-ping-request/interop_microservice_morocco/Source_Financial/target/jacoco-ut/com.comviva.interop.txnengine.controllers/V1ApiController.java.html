<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>V1ApiController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">interop-transaction-engine</a> &gt; <a href="index.source.html" class="el_package">com.comviva.interop.txnengine.controllers</a> &gt; <span class="el_source">V1ApiController.java</span></div><h1>V1ApiController.java</h1><pre class="source lang-java linenums">package com.comviva.interop.txnengine.controllers;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.context.request.async.DeferredResult;

import com.comviva.interop.txnengine.api.V1Api;
import com.comviva.interop.txnengine.configuration.BrokerServiceURLProperties;
import com.comviva.interop.txnengine.configuration.Resource;
import com.comviva.interop.txnengine.enums.LogConstants;
import com.comviva.interop.txnengine.enums.ServiceTypes;
import com.comviva.interop.txnengine.model.ConfirmTransactionRequest;
import com.comviva.interop.txnengine.model.ConfirmTransactionResponse;
import com.comviva.interop.txnengine.model.PendingTransactionRequest;
import com.comviva.interop.txnengine.model.PendingTransactionsResponse;
import com.comviva.interop.txnengine.model.QuotationRequest;
import com.comviva.interop.txnengine.model.QuotationResponse;
import com.comviva.interop.txnengine.model.ReceiveTransactionRequest;
import com.comviva.interop.txnengine.model.ReceiveTransactionResponse;
import com.comviva.interop.txnengine.model.Request;
import com.comviva.interop.txnengine.model.TransactionRequest;
import com.comviva.interop.txnengine.model.TransactionResponse;
import com.comviva.interop.txnengine.model.TransactionStatusRequest;
import com.comviva.interop.txnengine.model.TransactionStatusResponse;
import com.comviva.interop.txnengine.services.GetListOfTransactionsService;
import com.comviva.interop.txnengine.services.TransactionStatusService;
import com.comviva.interop.txnengine.strategies.ExecutableServicesMapper;
import com.comviva.interop.txnengine.util.ConfirmTransactionResponseCache;
import com.comviva.interop.txnengine.util.CreateTransactionResponseCache;
import com.comviva.interop.txnengine.util.LoggerUtil;
import com.comviva.interop.txnengine.util.PendingTransactionsResponseCache;
import com.comviva.interop.txnengine.util.ReceiveTransactionResponseCache;
import com.comviva.interop.txnengine.util.TransactionQuotationResponseCache;

import io.swagger.annotations.ApiParam;

@Controller
public class V1ApiController implements V1Api {
    
<span class="fc" id="L47">    private static final Logger LOGGER = LoggerFactory.getLogger(V1ApiController.class);</span>

    @Autowired
    private ExecutableServicesMapper executableServicesMapper;
    
    @Autowired
    private TransactionQuotationResponseCache transactionQuotationResponseCache;

    @Autowired
    private CreateTransactionResponseCache createTransactionResponseCache;

    @Autowired
    private TransactionStatusService transactionStatusService;

    @Autowired
    private GetListOfTransactionsService getTransactionsService;
    
    @Autowired
    private ReceiveTransactionResponseCache receiveTransactionResponseCache;
    
    @Autowired
    private BrokerServiceURLProperties brokerServiceURLProperties;
    
    @Autowired
    private Resource resource;
    
    @Autowired
    private PendingTransactionsResponseCache pendingTransactionsResponseCache;
    
    @Autowired
    private ConfirmTransactionResponseCache confirmTransactionResponseCache;
    
    @Autowired
    public V1ApiController(ExecutableServicesMapper executableServicesMapper,
<span class="fc" id="L81">            TransactionQuotationResponseCache transactionQuotationResponseCache) {</span>
<span class="fc" id="L82">        this.executableServicesMapper = executableServicesMapper;</span>
<span class="fc" id="L83">        this.transactionQuotationResponseCache = transactionQuotationResponseCache;</span>
<span class="fc" id="L84">    }</span>

    public DeferredResult&lt;ResponseEntity&lt;TransactionResponse&gt;&gt; createTransaction(
            @ApiParam(value = &quot;Fields of the Transaction request&quot;, required = true) @RequestBody TransactionRequest transactionRequest) {
<span class="fc" id="L88">        ServiceTypes serviceType = ServiceTypes.CREATE_TRANSACTION;</span>
<span class="fc" id="L89">        Request request = new Request(transactionRequest);</span>
<span class="fc" id="L90">        DeferredResult&lt;ResponseEntity&lt;TransactionResponse&gt;&gt; deferredResult = createTransactionResponseCache</span>
<span class="fc" id="L91">                .getDeferredResponseObj();</span>
<span class="fc" id="L92">        String interOpReferenceId = executableServicesMapper.generateInteropReferenceId();</span>
<span class="fc" id="L93">        String message = LoggerUtil.prepareLogDetailForCreateTxnRequest(transactionRequest, brokerServiceURLProperties.getUrlCountryIdValue(), interOpReferenceId,</span>
<span class="fc" id="L94">                LogConstants.INCOMING_REQUEST_EVENT_TYPE.getValue(), ServiceTypes.CREATE_TRANSACTION.toString(), resource.getPinLength());</span>
<span class="fc" id="L95">        LOGGER.info(&quot;create transaction service, request: {}&quot;, message);</span>
<span class="fc" id="L96">        executableServicesMapper.executeService(request, serviceType, interOpReferenceId);</span>
<span class="fc" id="L97">        createTransactionResponseCache.putInCache(interOpReferenceId, deferredResult);</span>
        
<span class="fc" id="L99">        return deferredResult;</span>
    }

  	public DeferredResult&lt;ResponseEntity&lt;ReceiveTransactionResponse&gt;&gt; receiveTransaction(
			@ApiParam(value = &quot;Fields of the Receive Transaction request&quot;, required = true) @RequestBody ReceiveTransactionRequest receiveTransactionRequest) {
<span class="fc" id="L104">		ServiceTypes serviceType = ServiceTypes.RECEIVE_TRANSACTION;</span>
<span class="fc" id="L105">		Request request = new Request(receiveTransactionRequest);</span>
<span class="fc" id="L106">		DeferredResult&lt;ResponseEntity&lt;ReceiveTransactionResponse&gt;&gt; deferredResult = receiveTransactionResponseCache</span>
<span class="fc" id="L107">				.getDeferredResponseObj();</span>
<span class="fc" id="L108">        String interOpReferenceId = executableServicesMapper.generateInteropReferenceId();</span>
<span class="fc" id="L109">		String message = LoggerUtil.prepareLogDetailForReceiveTxnRequest(receiveTransactionRequest, brokerServiceURLProperties.getUrlCountryIdValue(), interOpReferenceId, LogConstants.INCOMING_REQUEST_EVENT_TYPE.getValue(),</span>
<span class="fc" id="L110">		         ServiceTypes.RECEIVE_TRANSACTION.toString());</span>
<span class="fc" id="L111">		LOGGER.info(&quot;receive transaction service, request: {}&quot;, message);</span>
<span class="fc" id="L112">        executableServicesMapper.executeService(request, serviceType, interOpReferenceId);</span>
<span class="fc" id="L113">        receiveTransactionResponseCache.putInCache(interOpReferenceId, deferredResult);</span>
			    
<span class="fc" id="L115">		return deferredResult;</span>
	}

    public ResponseEntity&lt;TransactionStatusResponse&gt; v1TransactionsGet(
            @ApiParam(value = &quot;Language (ISO 639-1 format, like fr, en...)&quot;, required = true) @RequestParam(value = &quot;lang&quot;, required = true) String lang,
            @ApiParam(value = &quot;fetch all transactions corresponding to this external ID&quot;) @RequestParam(value = &quot;extOrgRefId&quot;, required = false) String extOrgRefId,
            @ApiParam(value = &quot;fetch all transactions after the start date. Date-time notation as defined by RFC 3339, section 5.6, for example, 2017-07-21T17:32:28Z&quot;) @RequestParam(value = &quot;startdate&quot;, required = false) String startdate,
            @ApiParam(value = &quot;fetch all transactions after the start date. Date-time notation as defined by RFC 3339, section 5.6, for example, 2017-07-21T17:32:28Z&quot;) @RequestParam(value = &quot;enddate&quot;, required = false) String enddate,
            @ApiParam(value = &quot;The number of items to skip before starting to collect&quot;, defaultValue = &quot;0&quot;) @RequestParam(value = &quot;offset&quot;, required = false, defaultValue = &quot;0&quot;) Integer offset,
            @ApiParam(value = &quot;The number of items in the result&quot;, defaultValue = &quot;10&quot;) @RequestParam(value = &quot;limit&quot;, required = false, defaultValue = &quot;10&quot;) Integer limit) {
<span class="fc" id="L125">        String message = LoggerUtil.prepareLogDetailForListOfTxnStatusRequest(brokerServiceURLProperties.getUrlCountryIdValue(),</span>
<span class="fc" id="L126">                null, LogConstants.INCOMING_REQUEST_EVENT_TYPE.getValue(), ServiceTypes.GET_TRANSACTIONS.toString(), lang, extOrgRefId, startdate, enddate, offset, limit);</span>
<span class="fc" id="L127">        LOGGER.info(&quot;transaction quotation service, request: {}&quot;, message);</span>
<span class="fc" id="L128">        TransactionStatusResponse transactionStatusResponse = getTransactionsService.getTransactions(lang, extOrgRefId,</span>
<span class="fc" id="L129">                startdate, enddate, offset, limit);</span>
<span class="fc" id="L130">        return new ResponseEntity&lt;&gt;(transactionStatusResponse, HttpStatus.OK);</span>
    }

    public ResponseEntity&lt;TransactionStatusResponse&gt; v1TransactionsInteropRefIdGet(
            @ApiParam(value = &quot;Path variable to uniquely identify an transaction (via interop reference identifier)&quot;, required = true) @PathVariable(&quot;interopRefId&quot;) String interopRefId,
            @ApiParam(value = &quot;Language (ISO 639-1 format, like fr, en...)&quot;, required = true) @PathVariable(&quot;lang&quot;) String lang) {

<span class="fc" id="L137">        TransactionStatusRequest transactionStatusRequest = new TransactionStatusRequest(interopRefId, lang);</span>
<span class="fc" id="L138">        String message = LoggerUtil.prepareLogDetailForTxnStatusRequest(transactionStatusRequest, brokerServiceURLProperties.getUrlCountryIdValue(),</span>
<span class="fc" id="L139">                interopRefId, LogConstants.INCOMING_REQUEST_EVENT_TYPE.getValue(), ServiceTypes.GET_TRANSACTION_STATUS.toString());</span>
<span class="fc" id="L140">        LOGGER.info(&quot;get transaction status service, request: {}&quot;, message);</span>
<span class="fc" id="L141">        Request request = new Request(transactionStatusRequest);</span>
<span class="fc" id="L142">        TransactionStatusResponse transactionStatusResponse = transactionStatusService</span>
<span class="fc" id="L143">                .getTransactionStatusByInteropRefId(request);</span>
<span class="fc" id="L144">        return new ResponseEntity&lt;&gt;(transactionStatusResponse, HttpStatus.OK);</span>
    }

    public DeferredResult&lt;ResponseEntity&lt;QuotationResponse&gt;&gt; v1TransactionsQuotationPost(
            @ApiParam(value = &quot;Fields of the Quotation request&quot;, required = true) @RequestBody QuotationRequest quotationRequest) {
<span class="fc" id="L149">        ServiceTypes serviceType = ServiceTypes.TRANSACTION_QUOTATION;</span>
<span class="fc" id="L150">        Request request = new Request(quotationRequest);</span>
<span class="fc" id="L151">        DeferredResult&lt;ResponseEntity&lt;QuotationResponse&gt;&gt; deferredResult = transactionQuotationResponseCache</span>
<span class="fc" id="L152">                .getDeferredResponseObj();</span>
<span class="fc" id="L153">        String interOpReferenceId = executableServicesMapper.generateInteropReferenceId();</span>
<span class="fc" id="L154">        String message = LoggerUtil.prepareLogDetailForTxnQuotationRequest(quotationRequest, brokerServiceURLProperties.getUrlCountryIdValue(), </span>
<span class="fc" id="L155">                interOpReferenceId, LogConstants.INCOMING_REQUEST_EVENT_TYPE.getValue(), ServiceTypes.TRANSACTION_QUOTATION.toString());</span>
<span class="fc" id="L156">        LOGGER.info(&quot;transaction quotation service, request: {}&quot;, message);</span>
<span class="fc" id="L157">        executableServicesMapper.executeService(request, serviceType, interOpReferenceId);</span>
<span class="fc" id="L158">        transactionQuotationResponseCache.putInCache(interOpReferenceId, deferredResult);</span>
<span class="fc" id="L159">        return deferredResult;</span>
    }

	@Override
	public DeferredResult&lt;ResponseEntity&lt;PendingTransactionsResponse&gt;&gt; getPendingTransactions(String msisdn,
			String numberOfTransactions, String lang) {
<span class="fc" id="L165">		 	ServiceTypes serviceType = ServiceTypes.PENDING_TRANSACTIONS;</span>
<span class="fc" id="L166">		 	PendingTransactionRequest pendingTransactionRequest = new PendingTransactionRequest(msisdn, numberOfTransactions, lang);</span>
<span class="fc" id="L167">	        DeferredResult&lt;ResponseEntity&lt;PendingTransactionsResponse&gt;&gt; deferredResult = pendingTransactionsResponseCache</span>
<span class="fc" id="L168">	                .getDeferredResponseObj();</span>
<span class="fc" id="L169">	        String interOpReferenceId = executableServicesMapper.generateInteropReferenceId();</span>
<span class="fc" id="L170">	        String message = LoggerUtil.prepareLogDetailForPendingTxnRequest(pendingTransactionRequest, brokerServiceURLProperties.getUrlCountryIdValue(), </span>
<span class="fc" id="L171">	                interOpReferenceId, LogConstants.INCOMING_REQUEST_EVENT_TYPE.getValue(), ServiceTypes.PENDING_TRANSACTIONS.toString());</span>
<span class="fc" id="L172">	        LOGGER.info(&quot;Pending Transactions service, request: {}&quot;, message);</span>
<span class="fc" id="L173">	        Request request = new Request(pendingTransactionRequest);</span>
<span class="fc" id="L174">	        executableServicesMapper.executeService(request, serviceType, interOpReferenceId);</span>
<span class="fc" id="L175">	        pendingTransactionsResponseCache.putInCache(interOpReferenceId, deferredResult);</span>
<span class="fc" id="L176">	        return deferredResult;</span>
	}

	@Override
	public DeferredResult&lt;ResponseEntity&lt;ConfirmTransactionResponse&gt;&gt; actionOnTransactionConfirmation(
			ConfirmTransactionRequest confirmTransactionRequest) {
<span class="fc" id="L182">		ServiceTypes serviceType = ServiceTypes.ACTION_ON_TRANSACTION_CONFIRMATION;</span>
<span class="fc" id="L183">        DeferredResult&lt;ResponseEntity&lt;ConfirmTransactionResponse&gt;&gt; deferredResult = confirmTransactionResponseCache.getDeferredResponseObj();</span>
<span class="fc" id="L184">        String interOpReferenceId = executableServicesMapper.generateInteropReferenceId();</span>
<span class="fc" id="L185">        String message = LoggerUtil.prepareLogDetailForConfirmTxnRequest(confirmTransactionRequest, brokerServiceURLProperties.getUrlCountryIdValue(), </span>
<span class="fc" id="L186">                interOpReferenceId, LogConstants.INCOMING_REQUEST_EVENT_TYPE.getValue(), ServiceTypes.ACTION_ON_TRANSACTION_CONFIRMATION.toString());</span>
<span class="fc" id="L187">        LOGGER.info(&quot;Confirm Transaction service, request: {}&quot;, message);</span>
<span class="fc" id="L188">        Request request = new Request(confirmTransactionRequest);</span>
<span class="fc" id="L189">        executableServicesMapper.executeService(request, serviceType, interOpReferenceId);</span>
<span class="fc" id="L190">        confirmTransactionResponseCache.putInCache(interOpReferenceId, deferredResult);</span>
<span class="fc" id="L191">        return deferredResult;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>