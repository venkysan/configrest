<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ReceiveTransactionService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">interop-transaction-engine</a> &gt; <a href="index.source.html" class="el_package">com.comviva.interop.txnengine.services</a> &gt; <span class="el_source">ReceiveTransactionService.java</span></div><h1>ReceiveTransactionService.java</h1><pre class="source lang-java linenums">package com.comviva.interop.txnengine.services;

import java.net.SocketTimeoutException;
import java.security.SecureRandom;
import java.util.Optional;
import java.util.concurrent.ExecutionException;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;
import java.util.concurrent.Future;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.ApplicationEventPublisher;
import org.springframework.scheduling.annotation.Async;
import org.springframework.stereotype.Service;
import org.springframework.web.client.RestClientException;

import com.comviva.interop.txnengine.configuration.BrokerServiceProperties;
import com.comviva.interop.txnengine.configuration.BrokerServiceURLProperties;
import com.comviva.interop.txnengine.configuration.SMSServerProperties;
import com.comviva.interop.txnengine.configuration.ServiceResources;
import com.comviva.interop.txnengine.entities.InteropTransactionDetails;
import com.comviva.interop.txnengine.entities.InteropTransactions;
import com.comviva.interop.txnengine.entities.SmsTemplates;
import com.comviva.interop.txnengine.enums.Constants;
import com.comviva.interop.txnengine.enums.InteropResponseCodes;
import com.comviva.interop.txnengine.enums.LogConstants;
import com.comviva.interop.txnengine.enums.RequestType;
import com.comviva.interop.txnengine.enums.SMSNotificationCodes;
import com.comviva.interop.txnengine.enums.Sources;
import com.comviva.interop.txnengine.enums.SuccessStatus;
import com.comviva.interop.txnengine.enums.ThirdPartyResponseCodes;
import com.comviva.interop.txnengine.enums.TransactionStatus;
import com.comviva.interop.txnengine.enums.TransactionSubTypes;
import com.comviva.interop.txnengine.enums.TransactionTypes;
import com.comviva.interop.txnengine.enums.UnicId;
import com.comviva.interop.txnengine.events.ReceiveTransactionResponseEvent;
import com.comviva.interop.txnengine.exception.InteropException;
import com.comviva.interop.txnengine.mobiquity.service.handlers.C2CHandler;
import com.comviva.interop.txnengine.mobiquity.service.handlers.P2PCashInHandler;
import com.comviva.interop.txnengine.mobiquity.service.handlers.RetailerGetLangHandler;
import com.comviva.interop.txnengine.mobiquity.service.handlers.SubscriberGetLangHandler;
import com.comviva.interop.txnengine.model.ReceiveTransactionRequest;
import com.comviva.interop.txnengine.model.ReceiveTransactionResponse;
import com.comviva.interop.txnengine.model.Request;
import com.comviva.interop.txnengine.model.RequestValidationResponse;
import com.comviva.interop.txnengine.model.Response;
import com.comviva.interop.txnengine.model.TxnMode;
import com.comviva.interop.txnengine.repositories.InteropTransactionDetailsRepository;
import com.comviva.interop.txnengine.repositories.InteropTransactionsRepository;
import com.comviva.interop.txnengine.repositories.SmsDeliveryRepository;
import com.comviva.interop.txnengine.repositories.SmsTemplatesRepository;
import com.comviva.interop.txnengine.request.validations.GetDescriptionForCode;
import com.comviva.interop.txnengine.request.validations.ValidateReceiveTransactionRequestBody;
import com.comviva.interop.txnengine.util.CastUtils;
import com.comviva.interop.txnengine.util.LoggerUtil;
import com.comviva.interop.txnengine.util.SMSUtility;
import com.comviva.interop.txnengine.util.TransactionDataPreparationUtil;

@Service(&quot;ReceiveTransactionService&quot;)
public class ReceiveTransactionService implements ExecutableServices {

<span class="fc" id="L64">	private static final Logger LOGGER = LoggerFactory.getLogger(ReceiveTransactionService.class);</span>

	@Autowired
	private ValidateReceiveTransactionRequestBody requestValidations;

	@Autowired
	private ApplicationEventPublisher applicationEventPublisher;

	@Autowired
	private GetDescriptionForCode getDescriptionForCode;

	@Autowired
	private SubscriberGetLangHandler mobiquityGetLangHandler;

	@Autowired
	private P2PCashInHandler p2PCashInHandler;

	@Autowired
	private ServiceResources serviceResources;

	@Autowired
	private SMSServerProperties resource;

	@Autowired
	private BrokerServiceProperties thirdPartyProperties;

	@Autowired
	private InteropTransactionsRepository interOpTransactionRepository;

	@Autowired
	private InteropTransactionDetailsRepository interopTransactionDetailsRepository;

	@Autowired
	private SmsTemplatesRepository smsTemplatesRepository;

	@Autowired
	private SmsDeliveryRepository smsDeliveryRepository;

	@Autowired
	private C2CHandler c2CHandler;

	@Autowired
	private BrokerServiceURLProperties brokerServiceURLProperties;

	@Autowired
	private RetailerGetLangHandler retailerGetLangHandler;

	@Autowired
	public ReceiveTransactionService(ValidateReceiveTransactionRequestBody requestValidations,
			ApplicationEventPublisher applicationEventPublisher, GetDescriptionForCode getDescriptionForCode,
			SubscriberGetLangHandler mobiquityGetLangHandler) {
<span class="fc" id="L115">		super();</span>
<span class="fc" id="L116">		this.requestValidations = requestValidations;</span>
<span class="fc" id="L117">		this.applicationEventPublisher = applicationEventPublisher;</span>
<span class="fc" id="L118">		this.getDescriptionForCode = getDescriptionForCode;</span>
<span class="fc" id="L119">		this.mobiquityGetLangHandler = mobiquityGetLangHandler;</span>
<span class="fc" id="L120">	}</span>

	@Override
    @Async
    public void execute(Request request) {
<span class="fc" id="L125">		String authorizationCode = getAuthorizationCode();</span>
<span class="fc" id="L126">        ReceiveTransactionRequest requestBody = CastUtils.toReceiveTransactionRequest(request.getRequestAttr());</span>
        try {
<span class="fc" id="L128">        	validateRequest(requestBody);</span>
<span class="fc" id="L129">        	requestProcess(requestBody,request,authorizationCode);</span>
<span class="fc" id="L130">        } catch (InteropException e) {</span>
<span class="fc" id="L131">        	updateTransactionStatus(request.getInteropReferenceId(), TransactionStatus.TRANSACTION_FAIL.getStatus());</span>
<span class="fc" id="L132">            ReceiveTransactionResponse receiveTransactionResponse = getReceiveTransactionResponse(requestBody, InteropResponseCodes.HPS_TXN_FAILED_ACTION_CODE.getStatusCode(),authorizationCode);</span>
<span class="fc" id="L133">            this.publishResponseEvent(receiveTransactionResponse, request.getInteropReferenceId(), e);</span>
<span class="fc" id="L134">        }catch(RestClientException e) {</span>
<span class="fc bfc" id="L135" title="All 2 branches covered.">            if(e.getCause() instanceof SocketTimeoutException) {</span>
<span class="fc" id="L136">            	updateTransactionStatus(request.getInteropReferenceId(), TransactionStatus.TRANSACTION_AMBIGUOUS.getStatus());</span>
            }
            else {
<span class="fc" id="L139">            	updateTransactionStatus(request.getInteropReferenceId(), TransactionStatus.TRANSACTION_FAIL.getStatus());</span>
            }
<span class="fc" id="L141">            ReceiveTransactionResponse receiveTransactionResponse = getReceiveTransactionResponse(requestBody, InteropResponseCodes.HPS_TXN_FAILED_ACTION_CODE.getStatusCode(),authorizationCode);</span>
<span class="fc" id="L142">            this.publishResponseEvent(receiveTransactionResponse, request.getInteropReferenceId(), e);</span>
<span class="fc" id="L143">        } catch (Exception ex) {</span>
<span class="fc" id="L144">        	updateTransactionStatus(request.getInteropReferenceId(), TransactionStatus.TRANSACTION_FAIL.getStatus());</span>
<span class="fc" id="L145">            ReceiveTransactionResponse receiveTransactionResponse = getReceiveTransactionResponse(requestBody, InteropResponseCodes.HPS_TXN_FAILED_ACTION_CODE.getStatusCode(),authorizationCode);</span>
<span class="fc" id="L146">            this.publishResponseEvent(receiveTransactionResponse, request.getInteropReferenceId(), ex);</span>
<span class="fc" id="L147">        }</span>
<span class="fc" id="L148">    }</span>
	
	private void requestProcess(ReceiveTransactionRequest requestBody,Request request,String authorizationCode) throws InterruptedException, ExecutionException {
<span class="fc" id="L151">		TransactionTypes recTxnType = getTransactionType(requestBody.getProcessingCode());</span>
<span class="fc" id="L152">        Response getLangResponse = new Response();</span>
<span class="fc" id="L153">        String requestType = null;</span>
<span class="fc" id="L154">        String responseType = null;</span>
<span class="pc bpc" id="L155" title="1 of 2 branches missed.">        Boolean isMPPull = Constants.MP_PULL_PROCESSING_CODE.getValue().equals(requestBody.getProcessingCode()) ? Boolean.TRUE : Boolean.FALSE;</span>
<span class="fc" id="L156">        InteropTransactions interopTransaction = null;</span>
<span class="pc bpc" id="L157" title="1 of 4 branches missed.">        if(TransactionTypes.MERCHPAY.equals(recTxnType) &amp;&amp; !isMPPull) {</span>
<span class="fc" id="L158">        	interopTransaction = interOpTransactionRepository.save(TransactionDataPreparationUtil.prepareInteropReceiveTransaction(requestBody, request,recTxnType.getTransactionType(), TransactionStatus.TRANSACTION_IN_PROGRESS.getStatus(), Boolean.FALSE));</span>
<span class="fc" id="L159">            getLangResponse = retailerGetLangHandler.callBrokerForRGetLangService(requestBody.getSourceAccountNumber(), requestBody.getDestinationAccountNumber(), request.getInteropReferenceId());</span>
<span class="fc" id="L160">            requestType = RequestType.RTMREQ.toString();</span>
<span class="fc" id="L161">            responseType = RequestType.RMRESP.toString();</span>
        }
<span class="pc bpc" id="L163" title="3 of 4 branches missed.">        else if(TransactionTypes.P2P.equals(recTxnType) || isMPPull ) {</span>
<span class="pc bpc" id="L164" title="1 of 2 branches missed.">        	if(!isMPPull) {</span>
<span class="fc" id="L165">        		interopTransaction = interOpTransactionRepository.save(TransactionDataPreparationUtil.prepareInteropReceiveTransaction(requestBody, request,recTxnType.getTransactionType(), TransactionStatus.TRANSACTION_IN_PROGRESS.getStatus(), Boolean.FALSE));</span>
        	}
<span class="fc" id="L167">            getLangResponse =  mobiquityGetLangHandler.execute(requestBody.getSourceAccountNumber(),requestBody.getDestinationAccountNumber(),</span>
<span class="fc" id="L168">            		request.getInteropReferenceId(), recTxnType);</span>
<span class="fc" id="L169">            requestType = RequestType.RCIREQ.toString();</span>
<span class="fc" id="L170">            responseType = RequestType.RCIRESP.toString();</span>
        }
<span class="fc" id="L172">        if  ((ThirdPartyResponseCodes.SUCCESS.getMappedCode()</span>
<span class="fc bfc" id="L173" title="All 2 branches covered.">				.equals(getLangResponse.getMappingResponse().getMappingCode())) ||</span>
<span class="pc bpc" id="L174" title="1 of 2 branches missed.">				(!ThirdPartyResponseCodes.USER_INVALID.getMappedCode().equals(getLangResponse.getMappingResponse().getMappingCode()) &amp;&amp;</span>
<span class="pc bpc" id="L175" title="1 of 2 branches missed.">						brokerServiceURLProperties.getBrokerSuccessCode().equals(getLangResponse.getBrokerResponse().getBrokerCode()))) {</span>
<span class="fc" id="L176">        	performTxn(isMPPull, requestBody, request, recTxnType, authorizationCode, requestType, responseType,  interopTransaction);</span>
        } else {
<span class="fc" id="L178">            throw new InteropException(getLangResponse.getMappingResponse().getMappingCode(),Sources.BROKER.toString());</span>
        }
<span class="fc" id="L180">	}</span>

	private TransactionTypes getTransactionType(String processingCode) {
<span class="fc" id="L183">		TransactionTypes recTxnType = null;</span>
<span class="fc bfc" id="L184" title="All 2 branches covered.">		if (Constants.MP_PROCESSING_CODE.getValue().equals(processingCode)</span>
<span class="pc bpc" id="L185" title="1 of 2 branches missed.">				|| Constants.MP_PULL_PROCESSING_CODE.getValue().equals(processingCode)) {</span>
<span class="fc" id="L186">			recTxnType = TransactionTypes.MERCHPAY;</span>
<span class="pc bpc" id="L187" title="3 of 4 branches missed.">		} else if (Constants.P2P_PROCESSING_CODE.getValue().equals(processingCode) || Constants.P2P_PROCESSING_CODE_ACCOUNT_TYPE1.getValue().equals(processingCode)</span>
<span class="nc bnc" id="L188" title="All 4 branches missed.">				|| Constants.P2P_PROCESSING_CODE_ACCOUNT_TYPE2.getValue().equals(processingCode) || Constants.P2P_PROCESSING_CODE_ACCOUNT_TYPE3.getValue().equals(processingCode)) {</span>
<span class="fc" id="L189">			recTxnType = TransactionTypes.P2P;</span>
		}
<span class="fc" id="L191">		return recTxnType;</span>
	}

	private void updateTransactionStatus(String interopRefId, String status) {
<span class="fc" id="L195">		InteropTransactions interopTransaction = interOpTransactionRepository</span>
<span class="fc" id="L196">				.findInteropTransactionsByTxnId(interopRefId);</span>
<span class="fc bfc" id="L197" title="All 2 branches covered.">		if (Optional.ofNullable(interopTransaction).isPresent()) {</span>
<span class="fc" id="L198">			interOpTransactionRepository.save(TransactionDataPreparationUtil.updateTransactionStatus(interopTransaction,status));</span>
		}
<span class="fc" id="L200">	}</span>

	private void publishResponseEvent(ReceiveTransactionResponse receiveTransactionResponse, String reqId,
			Exception exception) {
<span class="fc" id="L204">		ReceiveTransactionResponseEvent receiveTransactionResponseEvent = new ReceiveTransactionResponseEvent(this,</span>
				receiveTransactionResponse, reqId);
<span class="fc" id="L206">		String message = LoggerUtil.prepareLogDetailForReceiveTxnResponse(</span>
<span class="fc" id="L207">				brokerServiceURLProperties.getUrlCountryIdValue(), reqId,</span>
<span class="fc" id="L208">				LogConstants.OUTGOING_RESPONSE_EVENT_TYPE.getValue(), receiveTransactionResponse, exception);</span>
<span class="fc" id="L209">		LOGGER.info(&quot;Receive Transaction Response,{}&quot;, message);</span>
<span class="fc" id="L210">		applicationEventPublisher.publishEvent(receiveTransactionResponseEvent);</span>
<span class="fc" id="L211">	}</span>
	
	private void performTxn(Boolean isMPPull, ReceiveTransactionRequest requestBody, Request request, TransactionTypes recTxnType, String authorizationCode
			, String requestType, String responseType, InteropTransactions interopTransaction) throws InterruptedException, ExecutionException {
<span class="pc bpc" id="L215" title="1 of 2 branches missed.">		if(isMPPull) {</span>
<span class="nc" id="L216">    	    initiateMPPullTransaction(requestBody, request, recTxnType, authorizationCode);</span>
    	}
    	else {
<span class="fc" id="L219">    		doTheTransaction(recTxnType, requestBody, interopTransaction, authorizationCode, requestType, responseType);        		</span>
    	}
<span class="fc" id="L221">	}</span>

	private ReceiveTransactionResponse getReceiveTransactionResponse(ReceiveTransactionRequest request,
			String actionCode, String authorizationCode) {
<span class="fc" id="L225">		ReceiveTransactionResponse response = new ReceiveTransactionResponse();</span>
<span class="fc" id="L226">		response.setPan(request.getPan());</span>
<span class="fc" id="L227">		response.setProcessingCode(request.getProcessingCode());</span>
<span class="fc" id="L228">		response.setTransactionAmount(request.getTransactionAmount());</span>
<span class="fc" id="L229">		response.setConsolidationAmount(request.getConsolidationAmount());</span>
<span class="fc" id="L230">		response.setCardholderBillAmount(request.getCardholderBillAmount());</span>
<span class="fc" id="L231">		response.setDateAndTimeOfTransmission(request.getDateAndTimeOfTransmission());</span>
<span class="fc" id="L232">		response.setCardholderBillingEexchangeRate(request.getCardholderBillingEexchangeRate());</span>
<span class="fc" id="L233">		response.setSystemAuditNumber(request.getSystemAuditNumber());</span>
<span class="fc" id="L234">		response.setDateAndTimeOfTheTransaction(request.getDateAndTimeOfTheTransaction());</span>
<span class="fc" id="L235">		response.setSettlementDate(request.getSettlementDate());</span>
<span class="fc" id="L236">		response.setExchangeDate(request.getExchangeDate());</span>
<span class="fc" id="L237">		response.setBusinessType(request.getBusinessType());</span>
<span class="fc" id="L238">		response.setCountryCodeOfTheAcquiringOrganization(request.getCountryCodeOfTheAcquiringOrganization());</span>
<span class="fc" id="L239">		response.setCountryCodeOftheSenderOrganization(request.getCountryCodeOftheSenderOrganization());</span>
<span class="fc" id="L240">		response.setServicePointDataCode(request.getServicePointDataCode());</span>
<span class="fc" id="L241">		response.setFunctionCode(request.getFunctionCode());</span>
<span class="fc" id="L242">		response.setAuthorizationCode(authorizationCode);</span>
<span class="fc" id="L243">		response.setIdentificationCodeOfTheAcquiringOrganization(</span>
<span class="fc" id="L244">				request.getIdentificationCodeOfTheAcquiringOrganization());</span>
<span class="fc" id="L245">		response.setIdentificationCodeOfTheSendingOrganization(request.getIdentificationCodeOfTheSendingOrganization());</span>
<span class="fc" id="L246">		response.setReferenceNumberOfTheRecovery(request.getReferenceNumberOfTheRecovery());</span>
<span class="fc" id="L247">		response.setCurrencyCodeOfTheTransaction(request.getCurrencyCodeOfTheTransaction());</span>
<span class="fc" id="L248">		response.setCurrencyCodeOfTheCardholderInvoice(request.getCurrencyCodeOfTheCardholderInvoice());</span>
<span class="fc" id="L249">		response.setCurrencyCodeOfTheConsolidation(request.getCurrencyCodeOfTheConsolidation());</span>
<span class="fc" id="L250">		response.setSourceAccountNumber(request.getSourceAccountNumber());</span>
<span class="fc" id="L251">		response.setDestinationAccountNumber(request.getDestinationAccountNumber());</span>
<span class="fc" id="L252">		response.setActionCode(actionCode);</span>
<span class="pc bpc" id="L253" title="1 of 2 branches missed.">		response.setLengthOfTheAuthorizationCode(authorizationCode != null ? &quot;&quot; + authorizationCode.length() : &quot;0&quot;);</span>
<span class="fc" id="L254">		response.setSecurityCheckInfo(request.getSecurityCheckInfo());</span>
<span class="fc" id="L255">		return response;</span>
	}

	private void addSmsDelivery(String msisdn, String serviceType, String languageCode) {
<span class="fc" id="L259">		SmsTemplates smsTemplates = smsTemplatesRepository.findSmsTemplateByTypeAndLang(serviceType, languageCode);</span>
<span class="fc" id="L260">		smsDeliveryRepository.save(SMSUtility.prepareSMSDelivery(smsTemplates.getDescription(), msisdn, languageCode,</span>
<span class="fc" id="L261">				serviceType, resource.getNodeName()));</span>
<span class="fc" id="L262">	}</span>

	private String getAuthorizationCode() {
<span class="fc" id="L265">		return generateSixDigitUniqueId();</span>
	}

	public static String generateSixDigitUniqueId() {
<span class="fc" id="L269">		int idGenLen = 100000;</span>
<span class="fc" id="L270">		String idGenLenStr = &quot;000000&quot;;</span>
<span class="fc" id="L271">		SecureRandom generator = new SecureRandom();</span>
<span class="fc" id="L272">		generator.setSeed(System.currentTimeMillis());</span>
<span class="fc" id="L273">		int i = generator.nextInt(idGenLen) % idGenLen;</span>
<span class="fc" id="L274">		java.text.DecimalFormat f = new java.text.DecimalFormat(idGenLenStr);</span>
<span class="fc" id="L275">		return f.format(i);</span>
	}

	private void doTheTransaction(TransactionTypes recTxnType, ReceiveTransactionRequest requestBody,
			InteropTransactions interopTransaction, String authorizationCode, String requestType, String responseType) {
		Response response;
<span class="fc" id="L281">		TxnMode txnMode = new TxnMode(TransactionSubTypes.RECEIVE_TRANSACTION.toString(),</span>
<span class="fc" id="L282">				brokerServiceURLProperties.getUrlCountryIdValue(), brokerServiceURLProperties.getUrlCurrencyValue(),</span>
<span class="fc" id="L283">				brokerServiceURLProperties.getUrlAddonIdValue(), interopTransaction.getInteropTxnId(),</span>
<span class="fc" id="L284">				UnicId.ONE.getVal());</span>
<span class="fc" id="L285">		InteropTransactionDetails interopTransactionDetails = TransactionDataPreparationUtil</span>
<span class="fc" id="L286">				.prepareRequestTransactionDetails(interopTransaction, requestType, thirdPartyProperties,</span>
<span class="fc" id="L287">						Constants.ZERO.getValue(), Constants.ZERO.getValue());</span>
<span class="fc" id="L288">		String txnModeStr = txnMode.toString();</span>
<span class="fc" id="L289">		interopTransactionDetails.setTxnMode(txnModeStr);</span>
<span class="fc" id="L290">		interopTransactionDetailsRepository.save(interopTransactionDetails);</span>
<span class="fc bfc" id="L291" title="All 2 branches covered.">		if (recTxnType.equals(TransactionTypes.MERCHPAY)) {</span>
<span class="fc" id="L292">			response = c2CHandler.execute(requestBody.getSourceAccountNumber(),</span>
<span class="fc" id="L293">					thirdPartyProperties.getChannelUserMsisdn(), requestBody.getConsolidationAmount(),</span>
<span class="fc" id="L294">					interopTransaction.getInteropTxnId(), txnModeStr);</span>
		} else {
<span class="fc" id="L296">			response = p2PCashInHandler.execute(requestBody.getDestinationAccountNumber(),</span>
<span class="fc" id="L297">					requestBody.getConsolidationAmount(), interopTransaction.getInteropTxnId(), txnModeStr);</span>
		}
<span class="fc" id="L299">		interopTransaction.setAuthorizationCode(authorizationCode);</span>
<span class="pc bpc" id="L300" title="1 of 2 branches missed.">		if (!Optional.ofNullable(response.getMappingResponse()).isPresent()) {</span>
<span class="nc" id="L301">			interOpTransactionRepository.save(TransactionDataPreparationUtil.updateTransactionStatus(interopTransaction,</span>
<span class="nc" id="L302">					TransactionStatus.TRANSACTION_AMBIGUOUS.getStatus()));</span>
<span class="nc" id="L303">			TransactionDataPreparationUtil.prepareTransactionResponse(interopTransaction,</span>
<span class="nc" id="L304">					InteropResponseCodes.READ_TIMEOUT_FROM_BROKER.getStatusCode(),</span>
<span class="nc" id="L305">					getDescriptionForCode.getMappingCode(InteropResponseCodes.READ_TIMEOUT_FROM_BROKER.getStatusCode()),</span>
<span class="nc" id="L306">					getDescriptionForCode.getDescription(Sources.BROKER.toString(),</span>
<span class="nc" id="L307">							InteropResponseCodes.READ_TIMEOUT_FROM_BROKER.getStatusCode(),</span>
<span class="nc" id="L308">							serviceResources.getDefaultLanguage()));</span>
<span class="fc" id="L309">		} else if (ThirdPartyResponseCodes.SUCCESS.getMappedCode()</span>
<span class="pc bpc" id="L310" title="1 of 2 branches missed.">				.equals(response.getMappingResponse().getMappingCode())) {</span>
<span class="fc" id="L311">			interopTransaction.setMobiquityTransactionId(response.getWalletResponse().getTxnid());</span>
<span class="fc" id="L312">			interOpTransactionRepository.save(TransactionDataPreparationUtil.updateTransactionStatus(interopTransaction,</span>
<span class="fc" id="L313">					TransactionStatus.TRANSACTION_SUCCESS.getStatus()));</span>
<span class="fc" id="L314">			interopTransactionDetailsRepository.save(</span>
<span class="fc" id="L315">					TransactionDataPreparationUtil.prepareResponseTransactionDetails(interopTransaction, responseType,</span>
<span class="fc" id="L316">							response, thirdPartyProperties, Constants.ZERO.getValue(), Constants.ZERO.getValue()));</span>
<span class="fc" id="L317">			addSmsDelivery(requestBody.getDestinationAccountNumber(), SMSNotificationCodes.OFF_US_SUCCESS.toString(),</span>
<span class="fc" id="L318">					serviceResources.getDefaultLanguage());</span>
<span class="fc" id="L319">			this.publishResponseEvent(</span>
<span class="fc" id="L320">					getReceiveTransactionResponse(requestBody,</span>
<span class="fc" id="L321">							InteropResponseCodes.HPS_TXN_SUCCESS_ACTION_CODE.getStatusCode(), authorizationCode),</span>
<span class="fc" id="L322">					interopTransaction.getInteropTxnId(), null);</span>
		} else {
<span class="nc" id="L324">			interOpTransactionRepository.save(TransactionDataPreparationUtil.updateTransactionStatus(interopTransaction,</span>
<span class="nc" id="L325">					TransactionStatus.TRANSACTION_FAIL.getStatus()));</span>
<span class="nc" id="L326">			interopTransactionDetailsRepository.save(</span>
<span class="nc" id="L327">					TransactionDataPreparationUtil.prepareResponseTransactionDetails(interopTransaction, responseType,</span>
<span class="nc" id="L328">							response, thirdPartyProperties, Constants.ZERO.getValue(), Constants.ZERO.getValue()));</span>
<span class="nc" id="L329">			this.publishResponseEvent(</span>
<span class="nc" id="L330">					getReceiveTransactionResponse(requestBody,</span>
<span class="nc" id="L331">							InteropResponseCodes.HPS_TXN_FAILED_ACTION_CODE.getStatusCode(), authorizationCode),</span>
<span class="nc" id="L332">					interopTransaction.getInteropTxnId(), null);</span>
		}
<span class="fc" id="L334">	}</span>

	private void validateRequest(ReceiveTransactionRequest requestBody) {
<span class="fc" id="L337">		RequestValidationResponse requestValidationResponse = requestValidations.validate(requestBody);</span>
<span class="fc" id="L338">		if (!requestValidationResponse.getStatusCode()</span>
<span class="fc bfc" id="L339" title="All 2 branches covered.">				.equals(SuccessStatus.SUCCESSFUL_REQUEST_VALIDATION.getStatusCode())) {</span>
<span class="fc" id="L340">			throw new InteropException(requestValidationResponse.getStatusCode(),</span>
<span class="fc" id="L341">					requestValidationResponse.getEntity());</span>
		}
<span class="fc" id="L343">	}</span>

	private void initiateMPPullTransaction(ReceiveTransactionRequest requestBody, Request request,
			TransactionTypes recTxnType, String authorizationCode) throws InterruptedException, ExecutionException {
<span class="nc" id="L347">		InteropTransactions interopTransaction = interOpTransactionRepository</span>
<span class="nc" id="L348">				.save(TransactionDataPreparationUtil.prepareInteropReceiveTransaction(requestBody, request,</span>
<span class="nc" id="L349">						recTxnType.getTransactionType(), TransactionStatus.TRANSACTION_INITIATED.getStatus(), Boolean.TRUE));</span>
		// send USSD push
<span class="nc" id="L351">		ExecutorService executor = Executors.newSingleThreadExecutor();</span>
<span class="nc" id="L352">		boolean isTxnConfirmationInprogress = false;</span>
		do {
<span class="nc" id="L354">			Future&lt;Boolean&gt; future = executor.submit(new ConfirmTxnVerificationThread(</span>
<span class="nc" id="L355">					interopTransaction.getInteropTxnId(), interOpTransactionRepository));</span>
<span class="nc" id="L356">			isTxnConfirmationInprogress = future.get();</span>
<span class="nc bnc" id="L357" title="All 2 branches missed.">		} while (!isTxnConfirmationInprogress);</span>

<span class="nc" id="L359">		this.publishResponseEvent(</span>
<span class="nc" id="L360">				getReceiveTransactionResponse(requestBody,</span>
<span class="nc" id="L361">						InteropResponseCodes.HPS_TXN_SUCCESS_ACTION_CODE.getStatusCode(), authorizationCode),</span>
<span class="nc" id="L362">				request.getInteropReferenceId(), null);</span>
<span class="nc" id="L363">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>